version: 2.1

executors:
  maven:
    docker:
      - image: circleci/openjdk:8
    working_directory: ~/work
    environment:
      TZ: Asia/Tokyo

jobs:
  cache:
    executor: maven
    steps:
      - restore_cache: { keys: ['git-v1-{{ .Branch }}-{{ .Revision }}', 'git-v1-{{ .Branch }}', 'git-v1-'] }
      - restore_cache: { keys: ['m2-v1-{{ .Branch }}-{{ .Revision }}', 'm2-v1-{{ .Branch }}', 'm2-v1-'] }
      - checkout
      - run: mvn dependency:go-offline -B
      - save_cache: { key: 'git-v1-{{ .Branch }}-{{ .Revision }}', paths: ['.git'] }
      - save_cache: { key: 'm2-v1-{{ .Branch }}-{{ .Revision }}', paths: ['~/.m2'] }
  run:
    executor: maven
    steps:
      - restore_cache: { keys: ['git-v1-{{ .Branch }}-{{ .Revision }}', 'git-v1-{{ .Branch }}', 'git-v1-'] }
      - restore_cache: { keys: ['m2-v1-{{ .Branch }}-{{ .Revision }}', 'm2-v1-{{ .Branch }}', 'm2-v1-'] }
      - checkout
      - run: mvn package -o -V -B
      - run: mkdir -pv dist && cp -v target/*.jar dist
      - store_artifacts: { path: 'dist' }
  deploy:
    executor: maven
    steps:
      - restore_cache: { keys: ['git-v1-{{ .Branch }}-{{ .Revision }}', 'git-v1-{{ .Branch }}', 'git-v1-'] }
      - restore_cache: { keys: ['m2-v1-{{ .Branch }}-{{ .Revision }}', 'm2-v1-{{ .Branch }}', 'm2-v1-'] }
      - checkout
      - add_ssh_keys: { fingerprints: ['da:37:83:1c:a0:b4:5d:de:75:a7:64:c4:25:24:91:9a'] }
      - run: git clone git@github.com:AzisabaNetwork/mvn-repo.git
      - run: mvn deploy -DaltDeploymentRepository=local::default::file://mvn-repo -o -V -B
      - run: git config --global user.email 'null@azisaba.net'
      - run: git config --global user.name mvn-repo
      - run: cd mvn-repo && git add -A && git commit -m "Deploy @ $(date)" && git push origin master

workflows:
  version: 2
  commit: { jobs: [cache, run: { requires: [cache] }, deploy: { requires: [cache] }] }
